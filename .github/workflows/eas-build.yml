name: EAS Build

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to Build'
        required: true
        type: choice
        default: 'all'
        options:
          - 'all'
          - 'android'
          - 'ios'
      submit:
        description: 'Submit build to App Store and/or Google Play'
        required: true
        type: boolean
        default: false

jobs:
  define-env:
    name: Define Environment
    runs-on: ubuntu-latest
    outputs:
      app_env: ${{ steps.define-env.outputs.APP_ENV }}
    steps:
      - name: Define environment
        id: define-env
        env:
          BRANCH_REF: ${{ github.ref }}
          BASE_REF: ${{ github.event.base_ref }}
          COMMITISH: ${{ github.event.release.target_commitish }}
          TAG_REF: ${{ github.ref }}
        run: |
          if [[ "$BRANCH_REF" == *"heads/production" ]] || 
             ([[ "$BASE_REF" == *"heads/production" ]] && 
             [[ "$COMMITISH" == "production" ]] && 
             [[ "$TAG_REF" == refs/tags/v* ]]); then
            echo "APP_ENV=production" >> "$GITHUB_OUTPUT"
          else
            echo "APP_ENV=staging" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: define-env
    environment: ${{ needs.define-env.outputs.app_env }}
    env:
      INFISICAL_PROJECT_ID: xxxx
      INFISICAL_PATH: /gesture-consumer
    steps:
      - name: ğŸ— Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ— Install dependencies
        run: echo "npm ci"

      - name: Install Infisical CLI and login
        run: |
            echo "infisical login"

      - name: ğŸ— Setup Expo and EAS
        run: echo "expo login"
        # uses: expo/expo-github-action@v8
        # with:
        #   eas-version: latest
        #   token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸš€ Build app (Staging)
        if: needs.define-env.outputs.app_env == 'staging'
        run: |
          echo "build to staging"

      - name: ğŸš€ Build app (Production)
        if: needs.define-env.outputs.app_env == 'production'
        run: |
          echo "build to production"