# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting
on:
  release:
    types: [published]
  push:
    branches:
      - staging
jobs:
  define-environment:
    name: Define environment
    runs-on: ubuntu-latest
    outputs:
      ENV: ${{ steps.set-environment.outputs.ENV }}
      PROJECT_ID: ${{ steps.set-environment.outputs.PROJECT_ID }}
      FIREBASE_SERVICE_ACCOUNT: ${{ steps.set-environment.outputs.FIREBASE_SERVICE_ACCOUNT }}
    steps:
      - name: Set Environment
        id: set-environment
        run: |
          if [[ ${{ github.ref }} == *"/staging" ]]; then
            echo "ENV=staging" >> $GITHUB_OUTPUT
            echo "PROJECT_ID=test-project-d2235" >> $GITHUB_OUTPUT
            echo "FIREBASE_SERVICE_ACCOUNT=${{ secrets.FIREBASE_SERVICE_ACCOUNT_TEST_PROJECT_D2235 }}" >> $GITHUB_OUTPUT
            
          elif [[ ${{ github.ref }} == "refs/tags/v"* && ${{ github.event.release.target_commitish }} == "production" ]]; then
            echo "ENV=prod" >> $GITHUB_OUTPUT
            echo "PROJECT_ID=test-project-d2235" >> $GITHUB_OUTPUT
            echo "FIREBASE_SERVICE_ACCOUNT=${{ secrets.FIREBASE_SERVICE_ACCOUNT_TEST_PROJECT_D2235 }}" >> $GITHUB_OUTPUT
          fi
  build_and_deploy:
    runs-on: ubuntu-latest
    needs: define-environment
    if: ${{ needs.define-environment.outputs.ENV }}
    environment:
      name: ${{ needs.define-environment.outputs.ENV }}
    env:
      INFISICAL_PROJECT_ID: "593067cd-5aa1-4860-b02c-42ccc666e20c"
      INFISICAL_PATH: "/sub-folder"
    steps:
      - uses: actions/checkout@v4

      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y infisical

      - name: Login to Infisical and export envs
        run: |
          export INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id=${{ secrets.INFISICAL_CLIENT_ID }} --client-secret=${{ secrets.INFISICAL_CLIENT_SECRET }} --silent --plain)
          infisical export --env="${{needs.define-environment.outputs.ENV}}" --projectId="${{env.INFISICAL_PROJECT_ID}}" --path="${{env.INFISICAL_PATH}}" > .env

      - name: check .env file
        run: cat .env

      - run: echo "# npm ci && npm run build"

      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: ${{ needs.define-environment.outputs.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ needs.define-environment.outputs.PROJECT_ID }}
          channelId: live
